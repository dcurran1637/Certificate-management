<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sign in</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
</head>
<body>
  <main class="login-page">
    <header class="site-brand-wrap">
      <a class="site-brand d-flex align-items-center gap-2" href="/">
        <i class="bi bi-grid-1x2-fill site-brand-icon"></i>
        <span class="site-brand-text">Training Manager</span>
      </a>
    </header>

    <div class="login-card">
      <h1 class="login-title">Sign in</h1>
      <button id="btnLogin" class="btn-primary">
        <img src="Assets/Microsoft.png" alt="Microsoft logo" class="ms-logo" />
        <span>Continue with Microsoft</span>
      </button>
    </div>
  </main>

  <script>
    // MSAL + Microsoft Graph sign-in flow
    // Replace "YOUR_CLIENT_ID" with your Azure AD app (client) id.
    const LOGIN_SCOPES = ["openid", "profile", "User.Read"];

    const msalConfig = {
      auth: {
        clientId: "YOUR_CLIENT_ID",
        authority: "https://login.microsoftonline.com/organizations",
        // Use current page as redirect so this works on hosted deployments
        redirectUri: window.location.href,
        postLogoutRedirectUri: window.location.origin,
        navigateToLoginRequestUrl: false
      },
      cache: { cacheLocation: "sessionStorage" }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function handleRedirect() {
      try {
        const result = await msalInstance.handleRedirectPromise();
        const account = result?.account || msalInstance.getAllAccounts()[0];
        if (!account) return;

        // Try to silently acquire a token for Microsoft Graph
        try {
          const tokenResp = await msalInstance.acquireTokenSilent({ scopes: ["User.Read"], account });
          const accessToken = tokenResp.accessToken;
          const profile = await fetch("https://graph.microsoft.com/v1.0/me", {
            headers: { Authorization: `Bearer ${accessToken}` }
          }).then(r => r.json());

          // Persist minimal session info
          sessionStorage.setItem("account", JSON.stringify(account));
          sessionStorage.setItem("profile", JSON.stringify(profile));
          // Redirect to app shell
          window.location.replace("/app");
        } catch (err) {
          // Silent token acquisition failed - require interaction
          if (err instanceof msal.InteractionRequiredAuthError) {
            await msalInstance.acquireTokenRedirect({ scopes: ["User.Read"] });
          } else {
            console.error(err);
          }
        }
      } catch (e) {
        console.error('MSAL redirect handling failed', e);
      }
    }

    // Start handling redirect result right away
    handleRedirect();

    // Start interactive sign-in when button clicked
    document.getElementById("btnLogin").addEventListener("click", () => {
      msalInstance.loginRedirect({ scopes: LOGIN_SCOPES });
    });
  </script>
</body>
</html>